<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>옷마카세 | 아바타 생성/조절 데모</title>

  <!-- ✅ 핵심: importmap으로 bare specifier "three" 해결 -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
    }
  }
  </script>

  <style>
    html, body { margin: 0; height: 100%; overflow: hidden; background:#070a12; }
    #wrap { position: fixed; inset: 0; display: grid; grid-template-columns: minmax(300px, 360px) 1fr; }

    #panel{
      color:#e6e9f2; padding:14px; overflow:auto;
      border-right: 1px solid rgba(255,255,255,0.08);
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    }
    #panel h2 { margin: 0 0 10px; font-size: 14px; }
    #panel .hint { margin: 0 0 12px; font-size: 12px; color: rgba(230,233,242,0.75); line-height: 1.45; }

    .field { display:grid; gap: 6px; margin-bottom: 10px; }
    label { font-size: 12px; color: rgba(230,233,242,0.85); }

    input[type="text"]{
      width: 100%; box-sizing: border-box;
      padding: 10px; border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color:#e6e9f2; outline:none;
    }
    input[type="text"]:focus { border-color: rgba(255,255,255,0.25); }

    input[type="range"]{ width:100%; accent-color: #ffb020; }
    .kv { display:flex; align-items:center; justify-content:space-between; gap:10px; font-size: 12px; color: rgba(230,233,242,0.72); }

    .actions { display:flex; gap:10px; margin-top: 10px; }
    button{
      flex:1; padding:10px 12px; border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.10);
      color:#e6e9f2; cursor:pointer; font-weight: 800;
    }
    button:hover { background: rgba(255,255,255,0.14); }
    button.primary{
      border-color: rgba(255,176,32,0.28);
      background: rgba(255,176,32,0.12);
    }

    #view { position: relative; }
    canvas { display:block; width:100%; height:100%; }
    .badge{
      position:absolute; left: 12px; bottom: 12px;
      padding: 8px 10px; border-radius: 12px;
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.85);
      font-size: 12px;
    }
    .status{
      position:absolute; right: 12px; top: 12px;
      padding: 8px 10px; border-radius: 12px;
      background: rgba(0,0,0,0.50);
      border: 1px solid rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.90);
      font-size: 12px;
      max-width: min(560px, calc(100% - 24px));
      line-height: 1.45;
      backdrop-filter: blur(8px);
    }
    .status b { color: #ffcf6a; }
    .status code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 11px;
      color: rgba(255,255,255,0.92);
      background: rgba(255,255,255,0.08);
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.10);
    }

    @media (max-width: 860px) {
      #wrap { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
      #panel { border-right: none; border-bottom: 1px solid rgba(255,255,255,0.08); }
    }
  </style>
</head>

<body>
<div id="wrap">
  <div id="panel">
    <h2>아바타 불러오기 & 길이/비율 조절</h2>
    <p class="hint">
      GLB(스켈레톤 포함) 아바타를 불러온 뒤, 슬라이더로 키/팔/다리/몸통/어깨폭/골반폭을 조절합니다.<br/>
      드래그: 회전 / 휠: 확대·축소
    </p>

    <div class="field">
      <label>아바타 경로 (기본값: ./assets/avatar.glb)</label>
      <input id="modelUrl" type="text" />
    </div>

    <div class="actions">
      <button id="btnLoad" class="primary">로드</button>
      <label style="flex:1; display:flex; gap:10px; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,0.14); border-radius:12px; background:rgba(255,255,255,0.06); cursor:pointer; padding:10px 12px;">
        <span style="font-size:12px; font-weight:800; color:rgba(230,233,242,0.9);">파일 선택</span>
        <input id="filePick" type="file" accept=".glb,.gltf" style="display:none;">
      </label>
    </div>

    <div style="margin-top:14px; font-size:12px; font-weight:900; color:rgba(230,233,242,0.9);">길이/비율 조절</div>

    <div class="field">
      <label>전체 크기(Uniform Scale)</label>
      <input id="S_all" type="range" min="0.80" max="1.20" step="0.01" value="1.00" />
      <div class="kv"><span>값</span><span id="S_all_v">1.00</span></div>
    </div>

    <div class="field">
      <label>몸통 길이(Spine 계열)</label>
      <input id="S_torso" type="range" min="0.85" max="1.20" step="0.01" value="1.00" />
      <div class="kv"><span>값</span><span id="S_torso_v">1.00</span></div>
    </div>

    <div class="field">
      <label>다리 길이(UpperLeg/LowerLeg)</label>
      <input id="S_leg" type="range" min="0.85" max="1.25" step="0.01" value="1.00" />
      <div class="kv"><span>값</span><span id="S_leg_v">1.00</span></div>
    </div>

    <div class="field">
      <label>팔 길이(UpperArm/LowerArm)</label>
      <input id="S_arm" type="range" min="0.85" max="1.25" step="0.01" value="1.00" />
      <div class="kv"><span>값</span><span id="S_arm_v">1.00</span></div>
    </div>

    <div class="field">
      <label>어깨 폭(좌/우 UpperArm 위치)</label>
      <input id="S_shoulderW" type="range" min="0.85" max="1.25" step="0.01" value="1.00" />
      <div class="kv"><span>값</span><span id="S_shoulderW_v">1.00</span></div>
    </div>

    <div class="field">
      <label>골반 폭(좌/우 UpperLeg 위치)</label>
      <input id="S_hipW" type="range" min="0.85" max="1.25" step="0.01" value="1.00" />
      <div class="kv"><span>값</span><span id="S_hipW_v">1.00</span></div>
    </div>

    <div class="actions">
      <button id="btnReset">리셋</button>
      <button id="btnSave">설정 저장</button>
    </div>
  </div>

  <div id="view">
    <div class="status" id="status"><b>상태:</b> 초기화 중...</div>
    <div class="badge">Ootmakase | Avatar Adjust</div>
    <canvas id="c"></canvas>
  </div>
</div>

<script type="module">
  import * as THREE from "three";
  import { OrbitControls } from "three/addons/controls/OrbitControls.js";
  import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";

  const $ = (id)=> document.getElementById(id);
  const statusEl = $("status");
  const setStatus = (html)=> statusEl.innerHTML = html;

  const DEFAULT_MODEL_URL = new URL("./assets/avatar.glb", location.href).toString();
  $("modelUrl").value = DEFAULT_MODEL_URL;

  const sliderIds = ["S_all","S_torso","S_leg","S_arm","S_shoulderW","S_hipW"];
  function syncLabels(){
    for (const id of sliderIds) $(id+"_v").textContent = Number($(id).value).toFixed(2);
  }
  syncLabels();

  // --- THREE setup ---
  const canvas = $("c");
  const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:true });
  renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
  renderer.shadowMap.enabled = true;

  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x070a12);

  const camera = new THREE.PerspectiveCamera(45, 1, 0.01, 100);
  camera.position.set(1.7, 1.3, 2.6);

  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;

  scene.add(new THREE.HemisphereLight(0xffffff, 0x223355, 0.9));
  const key = new THREE.DirectionalLight(0xffffff, 1.15);
  key.position.set(2.8, 5.0, 2.2);
  key.castShadow = true;
  key.shadow.mapSize.set(2048, 2048);
  scene.add(key);

  const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(30, 30),
    new THREE.MeshStandardMaterial({ color: 0x0b1020, roughness: 1, metalness: 0 })
  );
  ground.rotation.x = -Math.PI / 2;
  ground.receiveShadow = true;
  scene.add(ground);

  const loader = new GLTFLoader();

  let modelGroup = null;
  let skeleton = null;
  let bones = {};
  const base = { groupScale: new THREE.Vector3(1,1,1), bonePos: new Map() };

  const normalizeName = (s)=> (s||"").toLowerCase().replaceAll(" ","").replaceAll("_","").replaceAll("-","");
  function findFirstSkinnedMesh(root){
    let found = null;
    root.traverse(o=>{ if (!found && o.isSkinnedMesh && o.skeleton) found = o; });
    return found;
  }
  function findBoneByAliases(aliases){
    if (!skeleton) return null;
    const aliasSet = aliases.map(normalizeName);

    for (const b of skeleton.bones){
      const n = normalizeName(b.name);
      if (aliasSet.includes(n)) return b;
    }
    for (const b of skeleton.bones){
      const n = normalizeName(b.name);
      for (const a of aliasSet) if (n.includes(a)) return b;
    }
    return null;
  }

  function captureBase(){
    base.groupScale.copy(modelGroup.scale);
    base.bonePos.clear();
    skeleton.bones.forEach(b=> base.bonePos.set(b.uuid, b.position.clone()));
  }
  function restoreBase(){
    if (!modelGroup || !skeleton) return;
    modelGroup.scale.copy(base.groupScale);
    skeleton.bones.forEach(b=>{
      const p = base.bonePos.get(b.uuid);
      if (p) b.position.copy(p);
    });
  }

  function scaleChildOffset(parentBone, childBone, factor){
    if (!parentBone || !childBone) return;
    const orig = base.bonePos.get(childBone.uuid);
    if (!orig) return;
    childBone.position.copy(orig).multiplyScalar(factor);
  }
  function scaleBoneXOffset(bone, factor){
    if (!bone) return;
    const orig = base.bonePos.get(bone.uuid);
    if (!orig) return;
    bone.position.set(orig.x * factor, orig.y, orig.z);
  }

  function mapBones(){
    bones = {};
    bones.hips   = findBoneByAliases(["hips","hip","pelvis","root","mixamorighips"]);
    bones.spine  = findBoneByAliases(["spine","spine01","spine1","spine_01","mixamorigspine"]);
    bones.chest  = findBoneByAliases(["chest","spine03","spine3","spine_03","spine02","spine2","spine_02","upperchest","mixamorigspine2","mixamorigchest"]);

    bones.lUpperArm = findBoneByAliases(["leftupperarm","upperarml","upperarm_l","mixamorigleftupperarm","mixamorigleftarm"]);
    bones.lLowerArm = findBoneByAliases(["leftlowerarm","lowerarml","lowerarm_l","mixamorigleftlowerarm","mixamorigleftforearm"]);
    bones.lHand     = findBoneByAliases(["lefthand","handl","hand_l","mixamoriglefthand"]);

    bones.rUpperArm = findBoneByAliases(["rightupperarm","upperarmr","upperarm_r","mixamorigrightupperarm","mixamorigrightarm"]);
    bones.rLowerArm = findBoneByAliases(["rightlowerarm","lowerarmr","lowerarm_r","mixamorigrightlowerarm","mixamorigrightforearm"]);
    bones.rHand     = findBoneByAliases(["righthand","handr","hand_r","mixamorigrighthand"]);

    bones.lUpperLeg = findBoneByAliases(["leftupperleg","upperlegl","upperleg_l","mixamorigleftupleg"]);
    bones.lLowerLeg = findBoneByAliases(["leftlowerleg","lowerlegl","lowerleg_l","mixamorigleftleg"]);
    bones.lFoot     = findBoneByAliases(["leftfoot","footl","foot_l","mixamorigleftfoot"]);

    bones.rUpperLeg = findBoneByAliases(["rightupperleg","upperlegr","upperleg_r","mixamorigrightupleg"]);
    bones.rLowerLeg = findBoneByAliases(["rightlowerleg","lowerlegr","lowerleg_r","mixamorigrightleg"]);
    bones.rFoot     = findBoneByAliases(["rightfoot","footr","foot_r","mixamorigrightfoot"]);
  }

  function applyAdjust(){
    if (!modelGroup || !skeleton) return;

    restoreBase();

    const sAll = Number($("S_all").value);
    const sTorso = Number($("S_torso").value);
    const sLeg = Number($("S_leg").value);
    const sArm = Number($("S_arm").value);
    const sShoulderW = Number($("S_shoulderW").value);
    const sHipW = Number($("S_hipW").value);

    modelGroup.scale.set(sAll, sAll, sAll);

    // torso
    if (bones.spine && bones.chest) scaleChildOffset(bones.spine, bones.chest, sTorso);
    else if (bones.hips && bones.spine) scaleChildOffset(bones.hips, bones.spine, sTorso);

    // legs
    if (bones.lUpperLeg && bones.lLowerLeg) scaleChildOffset(bones.lUpperLeg, bones.lLowerLeg, sLeg);
    if (bones.lLowerLeg && bones.lFoot)     scaleChildOffset(bones.lLowerLeg, bones.lFoot, sLeg);
    if (bones.rUpperLeg && bones.rLowerLeg) scaleChildOffset(bones.rUpperLeg, bones.rLowerLeg, sLeg);
    if (bones.rLowerLeg && bones.rFoot)     scaleChildOffset(bones.rLowerLeg, bones.rFoot, sLeg);

    // arms
    if (bones.lUpperArm && bones.lLowerArm) scaleChildOffset(bones.lUpperArm, bones.lLowerArm, sArm);
    if (bones.lLowerArm && bones.lHand)     scaleChildOffset(bones.lLowerArm, bones.lHand, sArm);
    if (bones.rUpperArm && bones.rLowerArm) scaleChildOffset(bones.rUpperArm, bones.rLowerArm, sArm);
    if (bones.rLowerArm && bones.rHand)     scaleChildOffset(bones.rLowerArm, bones.rHand, sArm);

    // widths
    if (bones.lUpperArm) scaleBoneXOffset(bones.lUpperArm, sShoulderW);
    if (bones.rUpperArm) scaleBoneXOffset(bones.rUpperArm, sShoulderW);
    if (bones.lUpperLeg) scaleBoneXOffset(bones.lUpperLeg, sHipW);
    if (bones.rUpperLeg) scaleBoneXOffset(bones.rUpperLeg, sHipW);
  }

  function setupShadows(root){
    root.traverse(o=>{
      if (o.isMesh){
        o.castShadow = true;
        o.receiveShadow = false;
      }
    });
  }

  function frameCamera(root){
    const box = new THREE.Box3().setFromObject(root);
    const size = new THREE.Vector3();
    const center = new THREE.Vector3();
    box.getSize(size);
    box.getCenter(center);

    const maxDim = Math.max(size.x, size.y, size.z);
    const dist = maxDim * 1.8;

    camera.position.set(center.x + dist*0.65, center.y + dist*0.55, center.z + dist*0.85);
    controls.target.copy(center.clone().add(new THREE.Vector3(0, maxDim*0.15, 0)));
    controls.update();
  }

  function clearModel(){
    if (!modelGroup) return;
    scene.remove(modelGroup);
    modelGroup = null;
    skeleton = null;
    bones = {};
    base.bonePos.clear();
  }

  async function loadFromUrl(url){
    try{
      setStatus(`<b>상태:</b> 로딩중...<br/><b>요청 URL:</b> <code>${url}</code>`);
      clearModel();

      const gltf = await loader.loadAsync(url);
      modelGroup = gltf.scene || gltf.scenes?.[0];
      if (!modelGroup) throw new Error("gltf.scene is empty");

      setupShadows(modelGroup);
      scene.add(modelGroup);

      const sk = findFirstSkinnedMesh(modelGroup);
      if (!sk || !sk.skeleton){
        frameCamera(modelGroup);
        setStatus(`<b>상태:</b> 모델 로드 완료<br/><b>경고:</b> SkinnedMesh(스켈레톤)를 찾지 못했습니다.`);
        return;
      }

      skeleton = sk.skeleton;
      captureBase();
      mapBones();
      frameCamera(modelGroup);
      applyAdjust();

      setStatus(`<b>상태:</b> 아바타 로드 완료<br/><b>스켈레톤:</b> ${skeleton.bones.length} bones`);
    }catch(err){
      console.error(err);
      setStatus(`<b>상태:</b> 로드 실패<br/><span style="color:#ff8a8a">${String(err?.message || err)}</span>`);
    }
  }

  $("btnLoad").addEventListener("click", ()=>{
    const raw = $("modelUrl").value.trim();
    const url = new URL(raw, location.href).toString();
    loadFromUrl(url);
  });

  $("filePick").addEventListener("change", (e)=>{
    const f = e.target.files?.[0];
    if (!f) return;
    const url = URL.createObjectURL(f);
    $("modelUrl").value = url;
    loadFromUrl(url);
  });

  $("btnReset").addEventListener("click", ()=>{
    $("S_all").value = 1.00;
    $("S_torso").value = 1.00;
    $("S_leg").value = 1.00;
    $("S_arm").value = 1.00;
    $("S_shoulderW").value = 1.00;
    $("S_hipW").value = 1.00;
    syncLabels();
    applyAdjust();
  });

  $("btnSave").addEventListener("click", ()=>{
    const cfg = {};
    for (const id of sliderIds) cfg[id] = Number($(id).value);
    localStorage.setItem("ootmakase_avatar_cfg", JSON.stringify(cfg));
    setStatus(`<b>상태:</b> 설정 저장 완료 (localStorage)`);
  });

  for (const id of sliderIds){
    $(id).addEventListener("input", ()=>{
      syncLabels();
      applyAdjust();
    });
  }

  function resize(){
    const w = canvas.clientWidth, h = canvas.clientHeight;
    renderer.setSize(w, h, false);
    camera.aspect = w / h;
    camera.updateProjectionMatrix();
  }
  addEventListener("resize", resize);

  function loop(){
    requestAnimationFrame(loop);
    resize();
    controls.update();
    renderer.render(scene, camera);
  }
  loop();

  const saved = localStorage.getItem("ootmakase_avatar_cfg");
  if (saved){
    try{
      const cfg = JSON.parse(saved);
      for (const id of sliderIds){
        if (cfg[id]) $(id).value = cfg[id];
      }
      syncLabels();
    }catch{}
  }

  loadFromUrl(DEFAULT_MODEL_URL);
</script>
</body>
</html>
