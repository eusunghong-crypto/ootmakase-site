<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ì˜·ë§ˆì¹´ì„¸ | ì•„ë°”íƒ€ ìƒì„± ì²´í—˜</title>

  <!-- âœ… GitHub Pagesì—ì„œ bare specifier("three") ì—ëŸ¬ ë°©ì§€ -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/"
    }
  }
  </script>

  <style>
    :root{
      --bg:#eef1f6;
      --panel:#ffffffcc;
      --panelSolid:#fff;
      --line:rgba(0,0,0,.08);
      --muted:#6b7280;
      --text:#0b0b0c;
      --blue:#4f6ef7;
      --shadow: 0 14px 34px rgba(0,0,0,.10);
      --shadow2: 0 10px 22px rgba(0,0,0,.08);
      --r:20px;
      --sat: env(safe-area-inset-top);
      --sar: env(safe-area-inset-right);
      --sab: env(safe-area-inset-bottom);
      --sal: env(safe-area-inset-left);
      --vh: 1vh;
    }
    *{ box-sizing:border-box }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",Arial,"Apple SD Gothic Neo",sans-serif;
      color:var(--text);
      background:linear-gradient(180deg,#f6f8fb 0%, #eef1f6 45%, #e9edf4 100%);
      padding: var(--sat) var(--sar) var(--sab) var(--sal);
      overflow:hidden;
    }
    button,input{ font-family:inherit; }
    input{ font-size:16px; } /* iOS ì¤Œ ë°©ì§€ */
    @media (min-width: 641px){ input{ font-size:13px; } }

    /* Top bar (ê°€ì§œ ì‡¼í•‘ëª° ëŠë‚Œ) */
    header{
      position:sticky; top:0; z-index:50;
      background:rgba(255,255,255,.70);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .topbar{
      max-width: 1400px;
      margin:0 auto;
      padding:12px 14px;
      display:flex; align-items:center; gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:1000;
      letter-spacing:-.2px;
      white-space:nowrap;
    }
    .brand .dot{
      width:10px; height:10px; border-radius:999px;
      background:#111;
      box-shadow:0 6px 14px rgba(0,0,0,.18);
    }
    .search{
      flex:1;
      display:flex; align-items:center; gap:10px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:999px;
      padding:10px 14px;
      min-height:40px;
      box-shadow:0 8px 18px rgba(0,0,0,.06);
      min-width:120px;
    }
    .search span{ font-size:12px; color:var(--muted); white-space:nowrap; }
    .search input{
      border:0; outline:0; width:100%;
      background:transparent;
      min-width:0;
      font-size:12px;
    }
    .topActions{ display:flex; align-items:center; gap:8px; }
    .chip{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:9px 12px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      min-height:38px;
      box-shadow:0 8px 18px rgba(0,0,0,.05);
    }
    .chip.primary{
      background:rgba(79,110,247,.12);
      border-color: rgba(79,110,247,.22);
      color:#123;
    }

    /* Main layout */
    .studioWrap{
      max-width: 1400px;
      margin:0 auto;
      padding:14px;
      height: calc((var(--vh) * 100) - 72px);
    }
    .studio{
      height:100%;
      display:grid;
      grid-template-columns: 96px 1fr 360px;
      gap:14px;
      min-height:0;
    }

    /* Left thumbs */
    .side{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius: var(--r);
      padding:10px;
      box-shadow:var(--shadow2);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .thumb{
      width:100%;
      aspect-ratio:1/1;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      overflow:hidden;
      cursor:pointer;
      position:relative;
      display:flex; align-items:center; justify-content:center;
      user-select:none;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .thumb.active{
      outline:3px solid rgba(79,110,247,.55);
      border-color: rgba(79,110,247,.35);
    }
    .thumb .tag{
      position:absolute; left:7px; bottom:7px;
      font-size:10px; font-weight:1000;
      padding:5px 8px;
      border-radius:999px;
      background:rgba(255,255,255,.86);
      border:1px solid rgba(0,0,0,.08);
      color:#111;
    }

    /* Center stage */
    .stage{
      min-height:0;
      border-radius: 24px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.07);
      box-shadow: var(--shadow);
      background: radial-gradient(circle at 50% 35%, #ffffff 0%, #f1f3f6 55%, #edf1f6 100%);
      display:flex;
      flex-direction:column;
    }
    .canvasWrap{ flex:1; min-height:0; position:relative; }
    canvas{ width:100%; height:100%; display:block; }

    .floatBtn{
      position:absolute;
      left:14px; bottom:14px;
      width:44px; height:44px;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.10);
      background:rgba(255,255,255,.85);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      font-weight:1000;
      box-shadow:0 10px 18px rgba(0,0,0,.10);
      user-select:none;
    }
    .statusPill{
      position:absolute;
      right:14px; top:14px;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(0,0,0,.55);
      color:#fff;
      border:1px solid rgba(255,255,255,.12);
      font-size:12px;
      white-space:pre-line;
      max-width:min(520px, calc(100% - 28px));
      backdrop-filter: blur(8px);
    }
    .statusPill b{ color:#ffcf6a; }

    /* Bottom tray */
    .tray{
      height:88px;
      padding:10px 12px;
      border-top:1px solid rgba(0,0,0,.07);
      background:rgba(255,255,255,.62);
      display:flex;
      gap:10px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      align-items:center;
    }
    .trayItem{
      width:62px; height:62px;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      overflow:hidden;
      cursor:pointer;
      flex:0 0 auto;
      display:flex; align-items:center; justify-content:center;
      user-select:none;
    }
    .trayItem img{ width:100%; height:100%; object-fit:cover; display:block; }
    .trayItem.active{
      outline:3px solid rgba(79,110,247,.55);
      border-color: rgba(79,110,247,.35);
    }

    /* Right panel */
    .panel{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius: var(--r);
      padding:12px;
      box-shadow:var(--shadow2);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .card{
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      padding:12px;
      box-shadow:0 8px 18px rgba(0,0,0,.06);
    }
    .row{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .row b{ font-size:13px; letter-spacing:-.1px; }
    .row span{ font-size:12px; color:var(--muted); font-variant-numeric: tabular-nums; }
    input[type="range"]{ width:100%; accent-color: var(--blue); }

    .btnRow{
      display:flex;
      gap:10px;
      margin-top:4px;
      flex-wrap:wrap;
    }
    .btnBlue{
      border:0;
      background:var(--blue);
      color:#fff;
      padding:12px 14px;
      border-radius:14px;
      font-weight:1000;
      cursor:pointer;
      box-shadow:0 12px 22px rgba(79,110,247,.22);
      min-height:42px;
      flex:1;
    }
    .btnWhite{
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      color:#111;
      padding:12px 14px;
      border-radius:14px;
      font-weight:1000;
      cursor:pointer;
      min-height:42px;
      flex:1;
    }

    details summary{
      cursor:pointer;
      font-weight:1000;
      font-size:13px;
      list-style:none;
    }
    details summary::-webkit-details-marker{ display:none; }
    .mini{
      margin-top:10px;
      display:grid;
      gap:10px;
    }
    .mini label{
      font-size:12px;
      font-weight:1000;
      display:block;
      margin-bottom:6px;
    }
    .mini input[type="file"], .mini input[type="text"]{
      width:100%;
      border:1px solid rgba(0,0,0,.10);
      border-radius:12px;
      padding:10px;
      background:#fff;
      font-size:12px;
      min-height:44px;
    }
    .checkRow{
      display:flex; align-items:center; gap:8px;
      font-size:12px; font-weight:1000; color:#111;
    }
    .hint{
      font-size:12px; color:var(--muted); line-height:1.45;
    }

    /* Responsive */
    @media (max-width: 980px){
      .studio{ grid-template-columns: 82px 1fr; }
      .panel{ display:none; }
    }
    @media (max-width: 640px){
      .topActions{ display:none; }
      .studioWrap{ padding:10px; }
      .studio{ grid-template-columns: 70px 1fr; gap:10px; }
      .tray{ height:78px; padding:8px 10px; }
      .stage{ border-radius: 20px; }
      .side{ border-radius: 18px; }
    }
  </style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="brand"><span class="dot"></span><span>ì˜·ë§ˆì¹´ì„¸</span></div>
    <div class="search">
      <span>Search</span>
      <input placeholder="ë¸Œëœë“œ, ìƒí’ˆëª…ì„ ê²€ìƒ‰í•˜ì„¸ìš” (ë°ëª¨)" />
    </div>
    <div class="topActions">
      <button class="chip">ë¡œê·¸ì¸</button>
      <button class="chip">ì°œ</button>
      <button class="chip primary" id="wearBtnTop">ì„ íƒ ì˜ìƒ ì…í˜€ë³´ê¸°</button>
    </div>
  </div>
</header>

<div class="studioWrap">
  <div class="studio">

    <!-- LEFT -->
    <aside class="side" id="side"></aside>

    <!-- CENTER -->
    <main class="stage">
      <div class="canvasWrap">
        <div class="statusPill" id="status"><b>ìƒíƒœ:</b> ì´ˆê¸°í™” ì¤‘...</div>
        <canvas id="c"></canvas>
        <div class="floatBtn" id="snapBtn" title="ìº¡ì²˜">ğŸ“·</div>
      </div>
      <div class="tray" id="tray"></div>
    </main>

    <!-- RIGHT -->
    <aside class="panel">
      <div class="card">
        <div class="row"><b>X Offset</b><span id="xv">0.00</span></div>
        <input id="x" type="range" min="-0.80" max="0.80" step="0.01" value="0.00">
      </div>
      <div class="card">
        <div class="row"><b>Y Offset</b><span id="yv">0.35</span></div>
        <input id="y" type="range" min="-0.30" max="5.00" step="0.01" value="0.35">
      </div>
      <div class="card">
        <div class="row"><b>Z Offset</b><span id="zv">0.00</span></div>
        <input id="z" type="range" min="-0.80" max="0.80" step="0.01" value="0.00">
      </div>
      <div class="card">
        <div class="row"><b>Scale</b><span id="sv">1.10</span></div>
        <input id="s" type="range" min="0.30" max="2.50" step="0.01" value="1.10">
      </div>
      <div class="card">
        <div class="row"><b>Rotation (Avatar)</b><span id="rv">0Â°</span></div>
        <input id="r" type="range" min="-180" max="180" step="1" value="0">
      </div>

      <div class="btnRow">
        <button class="btnBlue" id="autoFitBtn">Auto Fit</button>
        <button class="btnWhite" id="resetBtn">Reset</button>
      </div>

      <div class="card">
        <details>
          <summary>ê³ ê¸‰(ì•„ë°”íƒ€/ì˜ìƒ íŒŒì¼ ì—…ë¡œë“œ)</summary>
          <div class="mini">
            <div>
              <label>ì•„ë°”íƒ€ êµì²´(GLB)</label>
              <input type="file" id="avatarFile" accept=".glb,.gltf" />
              <div class="hint">ê¸°ë³¸: <code>./assets/avatar.glb</code></div>
            </div>

            <div>
              <label>ì˜ìƒ ì´ë¯¸ì§€ ì—…ë¡œë“œ(front PNG ê¶Œì¥)</label>
              <input type="file" id="frontFile" accept="image/png,image/webp,image/jpeg" />
            </div>
            <div>
              <label>ì˜ìƒ ì´ë¯¸ì§€ ì—…ë¡œë“œ(back, ì„ íƒ)</label>
              <input type="file" id="backFile" accept="image/png,image/webp,image/jpeg" />
            </div>

            <div class="btnRow">
              <button class="btnWhite" id="applyBtn">ì—…ë¡œë“œ ì ìš©</button>
              <button class="btnWhite" id="clearBtn">Clear</button>
            </div>

            <label class="checkRow">
              <input type="checkbox" id="occlusionChk">
              ìì—°ìŠ¤ëŸ¬ìš´ ê°€ë¦¼(DepthTest)
            </label>

            <div class="hint">
              ë¡œì»¬ í”„ë¦¬ì…‹ íŒŒì¼ ê·œì¹™(ìë™ í‘œì‹œìš©):<br/>
              <code>./garments/{id}_front.png</code>, <code>./garments/{id}_back.png</code>
            </div>
          </div>
        </details>
      </div>

      <div class="card">
        <div style="font-weight:1000; font-size:13px; margin-bottom:8px;">ì„ íƒ ì˜ìƒ</div>
        <div class="hint" id="selInfo">-</div>
        <div class="btnRow" style="margin-top:10px;">
          <button class="btnBlue" id="wearBtn">ì…í˜€ë³´ê¸°</button>
          <button class="btnWhite" id="flipBtn">Front/Back</button>
        </div>
      </div>
    </aside>

  </div>
</div>

<script>
(() => {
  function setVH(){
    const vh = (window.visualViewport ? window.visualViewport.height : window.innerHeight) * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
  }
  setVH();
  window.addEventListener('resize', setVH, { passive:true });
  window.visualViewport?.addEventListener('resize', setVH, { passive:true });
})();
</script>

<script type="module">
  import * as THREE from "three";
  import { OrbitControls } from "three/addons/controls/OrbitControls.js";
  import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";

  const $ = (id)=>document.getElementById(id);
  const statusEl = $("status");
  const setStatus = (t)=> statusEl.textContent = t;

  // ===============================
  // 1) ì˜ìƒ í”„ë¦¬ì…‹(ë„¤ê°€ ì›í•˜ëŠ”ëŒ€ë¡œ ëª©ë¡ ìˆ˜ì •)
  // - idë§Œ ë°”ê¾¸ë©´ garments/{id}_front.png ìë™ìœ¼ë¡œ ì°¾ìŒ
  // ===============================
  const GARMENTS = [
    { id:"ts-501", name:"ë² ì´ì‹ ë°˜íŒ” í‹°ì…”ì¸ ", cat:"TOP" },
    { id:"hd-210", name:"ë°ì¼ë¦¬ í›„ë””", cat:"TOP" },
    { id:"pt-101", name:"ìŠ¤íŠ¸ë ˆì´íŠ¸ ë°ë‹˜ íŒ¬ì¸ ", cat:"BOTTOM" }
  ];

  // ì¹´í…Œê³ ë¦¬ë³„ ìë™ í”„ë¦¬ì…‹(ì˜¤ë²„ë ˆì´ MVP ê¸°ì¤€)
  const TUNE_BY_CAT = {
    TOP:    { x:0.00, y:0.35, z:0.00, s:1.10, rot:0 },
    BOTTOM: { x:0.00, y:0.05, z:0.00, s:1.20, rot:0 },
    OUTER:  { x:0.00, y:0.40, z:0.00, s:1.18, rot:0 }
  };

  // ===============================
  // 2) UI ë Œë”(ì™¼ìª½/ì•„ë˜ ì¸ë„¤ì¼)
  // ===============================
  const side = $("side");
  const tray = $("tray");
  const selInfo = $("selInfo");

  let selected = GARMENTS[0];

  function makeThumb(item, where){
    const el = document.createElement("div");
    el.className = (where==="side") ? "thumb" : "trayItem";
    el.innerHTML = `
      <img src="./garments/${item.id}_front.png"
           onerror="this.remove(); this.parentElement.insertAdjacentHTML('beforeend','<div style=&quot;font-weight:1000; color:rgba(0,0,0,.45); font-size:12px;&quot;>IMG</div>');" />
      ${where==="side" ? `<div class="tag">${item.id}</div>` : ``}
    `;
    el.addEventListener("click", ()=>{
      selected = item;
      markActive();
      selInfo.textContent = `${item.name} Â· ${item.id} Â· ${item.cat}`;
    });
    return el;
  }

  function renderThumbs(){
    side.innerHTML = "";
    tray.innerHTML = "";
    GARMENTS.forEach(g=>{
      side.appendChild(makeThumb(g,"side"));
      tray.appendChild(makeThumb(g,"tray"));
    });
    markActive();
    selInfo.textContent = `${selected.name} Â· ${selected.id} Â· ${selected.cat}`;
  }

  function markActive(){
    [...side.children].forEach((el, i)=> el.classList.toggle("active", GARMENTS[i].id===selected.id));
    [...tray.children].forEach((el, i)=> el.classList.toggle("active", GARMENTS[i].id===selected.id));
  }

  renderThumbs();

  // ===============================
  // 3) THREE ê¸°ë³¸ ì„¸íŒ…
  // ===============================
  const canvas = $("c");
  const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:true, preserveDrawingBuffer:true });
  renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
  renderer.outputColorSpace = THREE.SRGBColorSpace;

  const scene = new THREE.Scene();
  scene.background = null;

  // âœ… far ë„‰ë„‰íˆ: í° ëª¨ë¸ë„ ì˜ë¦¼ ë°©ì§€
  const camera = new THREE.PerspectiveCamera(35, 1, 0.01, 5000);
  camera.position.set(0, 1.2, 2.4);

  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  renderer.domElement.style.touchAction = "none";

  scene.add(new THREE.HemisphereLight(0xffffff, 0x445566, 1.05));
  const dir = new THREE.DirectionalLight(0xffffff, 1.1);
  dir.position.set(3, 5, 2);
  scene.add(dir);

  // ë°”ë‹¥ ê·¸ë¦¼ì ëŠë‚Œ
  const disc = new THREE.Mesh(
    new THREE.CircleGeometry(0.6, 64),
    new THREE.MeshBasicMaterial({ color:0x000000, transparent:true, opacity:0.10 })
  );
  disc.rotation.x = -Math.PI/2;
  disc.position.y = 0.01;
  scene.add(disc);

  const root = new THREE.Group();
  scene.add(root);

  let avatar = null;
  let cloth = null;           // ì˜ìƒ ì˜¤ë²„ë ˆì´ plane
  let texFront = null;
  let texBack  = null;
  let forceFlip = false;

  const loader = new GLTFLoader();
  const texLoader = new THREE.TextureLoader();

  function resize(){
    const rect = canvas.getBoundingClientRect();
    const w = Math.max(1, Math.floor(rect.width));
    const h = Math.max(1, Math.floor(rect.height));
    renderer.setSize(w, h, false);
    camera.aspect = w/h;
    camera.updateProjectionMatrix();
  }
  window.addEventListener("resize", resize, { passive:true });
  if ("ResizeObserver" in window){
    new ResizeObserver(()=>resize()).observe(canvas.parentElement);
  }
  resize();

  function computeBox(obj){
    obj.updateWorldMatrix(true,true);
    const box = new THREE.Box3().setFromObject(obj);
    const size = new THREE.Vector3(); box.getSize(size);
    if (!isFinite(size.x) || !isFinite(size.y) || !isFinite(size.z) || (size.x+size.y+size.z)<1e-6){
      obj.traverse(o=>{
        if (o.isMesh && o.geometry){
          o.geometry.computeBoundingBox?.();
          o.geometry.computeBoundingSphere?.();
        }
      });
      obj.updateWorldMatrix(true,true);
      return new THREE.Box3().setFromObject(obj);
    }
    return box;
  }

  function placeOnGroundAndFrame(obj){
    const box = computeBox(obj);
    // ë°”ë‹¥ ìœ„ë¡œ
    obj.position.y += (-box.min.y);
    obj.updateWorldMatrix(true,true);

    const box2 = computeBox(obj);
    const size = new THREE.Vector3(); box2.getSize(size);
    const center = new THREE.Vector3(); box2.getCenter(center);

    const maxDim = Math.max(size.x,size.y,size.z);
    const dist = maxDim * 1.85;

    camera.far = Math.max(5000, dist*30);
    camera.updateProjectionMatrix();

    camera.position.set(center.x, center.y + size.y*0.15, center.z + dist);
    controls.target.set(center.x, center.y + size.y*0.55, center.z);
    controls.update();

    return { box:box2, size, center };
  }

  // ===============================
  // 4) ì˜ìƒ ì˜¤ë²„ë ˆì´(Plane billboard)
  // ===============================
  function ensureCloth(){
    if (cloth) return cloth;
    const geo = new THREE.PlaneGeometry(1, 1);
    const mat = new THREE.MeshBasicMaterial({
      transparent:true,
      opacity:1,
      depthTest:false,
      depthWrite:false
    });
    cloth = new THREE.Mesh(geo, mat);
    cloth.visible = false;
    cloth.renderOrder = 999;
    root.add(cloth);
    return cloth;
  }

  function setDepthMode(){
    const occ = $("occlusionChk").checked;
    if (!cloth) return;
    cloth.material.depthTest = occ ? true : false;
    cloth.material.depthWrite = false;
    cloth.material.needsUpdate = true;
  }
  $("occlusionChk").addEventListener("change", setDepthMode);

  function loadTexture(url){
    return new Promise((resolve, reject)=>{
      texLoader.load(url, (t)=>{
        t.colorSpace = THREE.SRGBColorSpace;
        resolve(t);
      }, undefined, reject);
    });
  }
  async function loadTextureFromFile(file){
    const url = URL.createObjectURL(file);
    try { return await loadTexture(url); }
    finally { URL.revokeObjectURL(url); }
  }

  function aspect(tex){
    const img = tex?.image;
    if(!img) return 0.75;
    const w = img.naturalWidth || img.width || 1;
    const h = img.naturalHeight || img.height || 1;
    return Math.max(0.1, w / Math.max(1,h));
  }

  // ì˜· ìœ„ì¹˜/í¬ê¸° ê³„ì‚°: ë°”ìš´ë”©ë°•ìŠ¤ ê¸°ë°˜
  const tune = { x:0, y:0.35, z:0, s:1.10, rot:0 };

  function updateTuneUI(){
    $("x").value = tune.x; $("y").value = tune.y; $("z").value = tune.z;
    $("s").value = tune.s; $("r").value = tune.rot;
    $("xv").textContent = Number(tune.x).toFixed(2);
    $("yv").textContent = Number(tune.y).toFixed(2);
    $("zv").textContent = Number(tune.z).toFixed(2);
    $("sv").textContent = Number(tune.s).toFixed(2);
    $("rv").textContent = `${Math.round(tune.rot)}Â°`;
  }
  updateTuneUI();

  function applyTuneFromSliders(){
    tune.x = Number($("x").value);
    tune.y = Number($("y").value);
    tune.z = Number($("z").value);
    tune.s = Number($("s").value);
    tune.rot = Number($("r").value);

    $("xv").textContent = Number(tune.x).toFixed(2);
    $("yv").textContent = Number(tune.y).toFixed(2);
    $("zv").textContent = Number(tune.z).toFixed(2);
    $("sv").textContent = Number(tune.s).toFixed(2);
    $("rv").textContent = `${Math.round(tune.rot)}Â°`;

    if (avatar) avatar.rotation.y = (tune.rot * Math.PI)/180;
    placeCloth();
  }
  ["x","y","z","s","r"].forEach(id => $(id).addEventListener("input", applyTuneFromSliders));

  function chooseFrontBackTexture(){
    if (!cloth || !cloth.material.map) return;

    const hasBoth = !!(texFront && texBack);
    if (!hasBoth) return;

    // ì¹´ë©”ë¼ê°€ ì•„ë°”íƒ€ ê¸°ì¤€ ì•/ë’¤ì¸ì§€ë¡œ ê²°ì •(ê°„ë‹¨ íŒì •)
    const camLocal = camera.position.clone();
    root.worldToLocal(camLocal);
    let frontView = camLocal.z > 0;
    if (forceFlip) frontView = !frontView;

    const next = frontView ? texFront : texBack;
    if (cloth.material.map !== next){
      cloth.material.map = next;
      cloth.material.needsUpdate = true;
    }
  }

  function placeCloth(){
    if (!avatar || !cloth) return;
    if (!cloth.material.map) return;

    const box = computeBox(avatar);
    const size = new THREE.Vector3(); box.getSize(size);
    const center = new THREE.Vector3(); box.getCenter(center);

    // ì¹´í…Œê³ ë¦¬ë³„ ê¸°ë³¸ ìœ„ì¹˜ (TOP/BOTTOM/OUTER)
    const cat = selected?.cat || "TOP";
    let yFrac = 0.80;
    let hFrac = 0.62;
    if (cat==="BOTTOM"){ yFrac = 0.50; hFrac = 0.80; }
    if (cat==="OUTER"){ yFrac = 0.82; hFrac = 0.72; }

    const yy = box.min.y + size.y * yFrac + (tune.y * size.y);
    const h = size.y * hFrac * tune.s;

    const a = aspect(cloth.material.map);
    let w = h * a;
    w = Math.max(w, size.x * 0.40);
    w = Math.min(w, size.x * 1.15);

    // ì•½ê°„ ì•ìœ¼ë¡œ ë¹¼ê¸°(ê°€ë¦¼ ONì´ë©´ ì¡°ê¸ˆ ëœ)
    const occ = $("occlusionChk").checked;
    const zPush = occ ? (size.z * 0.10) : (size.z * 0.18);

    cloth.position.set(center.x + tune.x, yy, center.z + zPush + tune.z);
    cloth.scale.set(w, h, 1);
    cloth.visible = true;
  }

  // ë§¤ í”„ë ˆì„ billboard(ì˜·ì´ ì¹´ë©”ë¼ë¥¼ ë³´ê²Œ)
  function billboardCloth(){
    if (!cloth || !cloth.visible) return;
    cloth.lookAt(camera.position);
  }

  // ===============================
  // 5) ì•„ë°”íƒ€ ë¡œë“œ
  // ===============================
  function clearAvatar(){
    if (!avatar) return;
    root.remove(avatar);
    avatar.traverse(o=>{
      if (o.isMesh){
        o.geometry?.dispose?.();
        if (Array.isArray(o.material)) o.material.forEach(m=>m?.dispose?.());
        else o.material?.dispose?.();
      }
    });
    avatar = null;
  }

  async function loadAvatar(url){
    try{
      setStatus(`ìƒíƒœ: ì•„ë°”íƒ€ ë¡œë”©ì¤‘...\nURL: ${url}`);
      clearAvatar();

      const gltf = await loader.loadAsync(url);
      avatar = gltf.scene || gltf.scenes?.[0];
      if (!avatar) throw new Error("gltf.scene is empty");

      // ê¸°ë³¸ ê·¸ë¦¼ì/ì¬ì§ˆ ì¡°ê¸ˆ ë³´ì •(ë„ˆë¬´ ì–´ë‘ìš´ ëª¨ë¸ ëŒ€ë¹„)
      avatar.traverse(o=>{
        if (o.isMesh){
          o.castShadow = true;
          if (o.material && o.material.isMeshStandardMaterial){
            o.material.roughness = Math.min(1, o.material.roughness ?? 0.8);
          }
        }
      });

      root.add(avatar);
      const info = placeOnGroundAndFrame(avatar);

      // ì˜· ì˜¤ë²„ë ˆì´ ì¤€ë¹„
      ensureCloth();
      setDepthMode();

      setStatus(
        `ìƒíƒœ: ì•„ë°”íƒ€ ë¡œë“œ ì™„ë£Œ\n`+
        `bbox: ${info.size.x.toFixed(2)} x ${info.size.y.toFixed(2)} x ${info.size.z.toFixed(2)}\n`+
        `camera.far: ${camera.far.toFixed(0)}`
      );

      // íšŒì „ ì ìš©
      avatar.rotation.y = (tune.rot * Math.PI)/180;
      placeCloth();
    }catch(e){
      console.error(e);
      setStatus(`ìƒíƒœ: ì•„ë°”íƒ€ ë¡œë“œ ì‹¤íŒ¨\n${String(e?.message || e)}`);
    }
  }

  // ê¸°ë³¸ ìë™ ë¡œë“œ: ./assets/avatar.glb
  const DEFAULT_AVATAR_URL = new URL("./assets/avatar.glb", location.href).toString();
  await loadAvatar(DEFAULT_AVATAR_URL);

  // ì•„ë°”íƒ€ íŒŒì¼ êµì²´
  $("avatarFile").addEventListener("change", async ()=>{
    const f = $("avatarFile").files?.[0];
    if (!f) return;
    const url = URL.createObjectURL(f);
    try { await loadAvatar(url); }
    finally { URL.revokeObjectURL(url); }
  });

  // ===============================
  // 6) ì˜ìƒ ì ìš© ë¡œì§
  // ===============================
  async function wearSelected(){
    try{
      ensureCloth();
      setDepthMode();

      // ìš°ì„  ë¡œì»¬ garments í´ë”ì—ì„œ ì°¾ê³ , ì—†ìœ¼ë©´ ì—ëŸ¬ ì•ˆë‚´
      const frontUrl = new URL(`./garments/${selected.id}_front.png`, location.href).toString();
      const backUrl  = new URL(`./garments/${selected.id}_back.png`, location.href).toString();

      texFront = null; texBack = null;

      // front í•„ìˆ˜
      texFront = await loadTexture(frontUrl);

      // backì€ ì„ íƒ
      try { texBack = await loadTexture(backUrl); } catch(_) { texBack = null; }

      cloth.material.map = texFront;
      cloth.material.needsUpdate = true;
      cloth.visible = true;

      // ì¹´í…Œê³ ë¦¬ í”„ë¦¬ì…‹ ìë™ ì ìš©(ì›í•˜ë©´ ì‚­ì œ ê°€ëŠ¥)
      const base = TUNE_BY_CAT[selected.cat] || TUNE_BY_CAT.TOP;
      tune.x = base.x; tune.y = base.y; tune.z = base.z; tune.s = base.s;
      updateTuneUI();
      applyTuneFromSliders();

      setStatus(`ìƒíƒœ: ì˜ìƒ ì ìš© ì™„ë£Œ\n${selected.name} Â· ${selected.id}\n(back: ${texBack ? "ìˆìŒ" : "ì—†ìŒ"})`);
    }catch(e){
      console.warn(e);
      setStatus(`ìƒíƒœ: ì˜ìƒ ì ìš© ì‹¤íŒ¨\n./garments/${selected.id}_front.png ë¥¼ í™•ì¸í•˜ì„¸ìš”.\n(ì—†ìœ¼ë©´ 'ì—…ë¡œë“œ ì ìš©' ì‚¬ìš©)`);
    }
  }

  $("wearBtn").addEventListener("click", wearSelected);
  $("wearBtnTop").addEventListener("click", wearSelected);

  $("flipBtn").addEventListener("click", ()=>{
    forceFlip = !forceFlip;
    $("flipBtn").textContent = forceFlip ? "Front/Back (ON)" : "Front/Back";
    chooseFrontBackTexture();
  });

  // ì—…ë¡œë“œ ì ìš©
  $("applyBtn").addEventListener("click", async ()=>{
    const f = $("frontFile").files?.[0] || null;
    const b = $("backFile").files?.[0] || null;
    if (!f){
      setStatus("ìƒíƒœ: ì—…ë¡œë“œ ì ìš© ì‹¤íŒ¨\nfront ì´ë¯¸ì§€ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");
      return;
    }
    try{
      texFront = await loadTextureFromFile(f);
      texBack = b ? await loadTextureFromFile(b) : null;

      ensureCloth();
      setDepthMode();

      cloth.material.map = texFront;
      cloth.material.needsUpdate = true;
      cloth.visible = true;

      // ì„ íƒ cat í”„ë¦¬ì…‹
      const base = TUNE_BY_CAT[selected.cat] || TUNE_BY_CAT.TOP;
      tune.x = base.x; tune.y = base.y; tune.z = base.z; tune.s = base.s;
      updateTuneUI();
      applyTuneFromSliders();

      setStatus(`ìƒíƒœ: ì—…ë¡œë“œ ì˜ìƒ ì ìš© ì™„ë£Œ\nfront: OK / back: ${texBack ? "OK" : "ì—†ìŒ"}`);
    }catch(e){
      console.error(e);
      setStatus(`ìƒíƒœ: ì—…ë¡œë“œ ì˜ìƒ ì ìš© ì‹¤íŒ¨\n${String(e?.message || e)}`);
    }
  });

  $("clearBtn").addEventListener("click", ()=>{
    texFront = null; texBack = null;
    if (cloth){
      cloth.visible = false;
      cloth.material.map = null;
      cloth.material.needsUpdate = true;
    }
    setStatus("ìƒíƒœ: ì˜ìƒ ì œê±° ì™„ë£Œ");
  });

  // Auto Fit / Reset
  $("autoFitBtn").addEventListener("click", ()=>{
    const base = TUNE_BY_CAT[selected.cat] || TUNE_BY_CAT.TOP;
    tune.x = base.x; tune.y = base.y; tune.z = base.z; tune.s = base.s;
    updateTuneUI();
    applyTuneFromSliders();
    setStatus(`ìƒíƒœ: Auto Fit ì ìš©\ncat: ${selected.cat}`);
  });

  $("resetBtn").addEventListener("click", ()=>{
    tune.x = 0; tune.y = 0.35; tune.z = 0; tune.s = 1.10; tune.rot = 0;
    updateTuneUI();
    applyTuneFromSliders();
    setStatus("ìƒíƒœ: Reset ì™„ë£Œ");
  });

  // ìº¡ì²˜
  $("snapBtn").addEventListener("click", ()=>{
    try{
      const a = document.createElement("a");
      a.download = `fit_${selected?.id || "snap"}.png`;
      a.href = renderer.domElement.toDataURL("image/png");
      a.click();
      setStatus("ìƒíƒœ: ìº¡ì²˜ ì™„ë£Œ\nPNG ì €ì¥ì„ ì‹œì‘í–ˆìŠµë‹ˆë‹¤.");
    }catch(_){
      setStatus("ìƒíƒœ: ìº¡ì²˜ ì‹¤íŒ¨\në¸Œë¼ìš°ì € ë³´ì•ˆ ì„¤ì •ì— ë”°ë¼ ë§‰í ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
    }
  });

  // ===============================
  // 7) ë Œë” ë£¨í”„
  // ===============================
  function loop(){
    requestAnimationFrame(loop);
    controls.update();
    chooseFrontBackTexture();
    placeCloth();
    billboardCloth();
    renderer.render(scene, camera);
  }
  loop();

  // ì´ˆê¸° ì•ˆë‚´
  setStatus("ìƒíƒœ: ì¤€ë¹„ ì™„ë£Œ\nì™¼ìª½ ì¸ë„¤ì¼ ì„ íƒ â†’ 'ì…í˜€ë³´ê¸°'ë¡œ ì ìš©");
</script>
</body>
</html>
